<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Figurama</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/components/buttons.css}">
    <link rel="stylesheet" th:href="@{/css/components/cards.css}">
    <link rel="stylesheet" th:href="@{/css/components/forms.css}">
    <link rel="stylesheet" th:href="@{/css/pages/dashboard.css}">
</head>
<body>
    <div th:replace="~{fragments/header_logged :: logado}"></div>

    <main class="dashboard">
        <h2 class="wb">Bem-vindo de volta <span id="username">Colecionador</span>, suas coleções te esperam...</h2>

        <section class="stats">
            <div class="stat">
                <span class="stat-number" id="total-figures">0</span>
                <span>Figuras salvas</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="total-collections">0</span>
                <span>Coleções criadas</span>
            </div>

            <div class="recent">
                <h4>Últimas adicionadas</h4>
                <div class="recent-grid" id="recent-grid">
                    </div>
            </div>
        </section>

        <hr>

        <section class="collections-section">
            <h3>Suas Coleções</h3>
            <div class="collections" id="collections-container">
                <p style="color: #666; padding: 20px;">Você ainda não possui coleções.</p>
                </div>
        </section>

        <section class="novidades-section">
            <div class="new-text">
                <h3>Novidades</h3>
                <a th:href="@{/explorar}">Ver mais...</a>
            </div>

            <div class="news-grid" id="news-grid">
                </div>
        </section>

        <section class="populares-section">
            <div class="new-text">
                <h3>Populares no momento</h3>
                <a th:href="@{/explorar}">Ver mais...</a>
            </div>

            <div class="popular-grid" id="popular-grid">
                </div>
        </section>
    </main>

    <script>
        const API_BASE = '/api';

        function checkAuth() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return null;
            }
            return token;
        }

        function loadUserData() {
            const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                // Tenta pegar username ou nome, ou define um padrão
                const nomeExibicao = user.username || user.nome || 'Colecionador';
                document.getElementById('username').textContent = nomeExibicao;
                
                // Atualiza também no Header se houver o campo lá
                const headerName = document.getElementById('header-user-name');
                if(headerName) headerName.textContent = nomeExibicao;
            }
        }

        async function loadStats() {
            document.getElementById('total-figures').textContent = "0";
            document.getElementById('total-collections').textContent = "0";
        }

        async function loadCatalogoData() {
            try {
                // Chama seu endpoint existente: /api/catalogo
                const response = await fetch(`${API_BASE}/catalogo`);
                if (!response.ok) throw new Error('Erro ao buscar catálogo');
                
                const figures = await response.json();

                const novidades = figures.slice(-4).reverse();
                renderGrid('news-grid', novidades);
                renderGrid('recent-grid', novidades.slice(0, 3)); 

                const populares = figures.slice(0, 4);
                renderGrid('popular-grid', populares);

            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function renderGrid(elementId, lista) {
            const grid = document.getElementById(elementId);
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (lista.length === 0) {
                grid.innerHTML = '<p>Nenhuma figura encontrada.</p>';
                return;
            }

            lista.forEach(fig => {
                const card = document.createElement('div');
                card.className = elementId === 'recent-grid' ? 'recent-card' : 'news-card'; 
                
                card.innerHTML = `
                    <img src="${fig.urlFoto || '/img/placeholder.png'}" alt="${fig.nome}">
                    ${elementId !== 'recent-grid' ? `<div class="card-info"><h4>${fig.nome}</h4></div>` : ''}
                `;
                
                card.onclick = () => window.location.href = `/detalhes?id=${fig.id}`;
                
                grid.appendChild(card);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = checkAuth();
            if (token) {
                loadUserData();
                loadStats();
                loadCatalogoData();
            }
        });
    </script>
</body>
</html>