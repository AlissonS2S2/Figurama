<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Figurama</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/components/buttons.css}">
    <link rel="stylesheet" th:href="@{/css/components/cards.css}">
    <link rel="stylesheet" th:href="@{/css/components/forms.css}">
    <link rel="stylesheet" th:href="@{/css/pages/dashboard.css}">
</head>
<body>
    <div th:replace="~{fragments/header_logged :: logado}"></div>

    <main class="dashboard">
        <h2 class="wb">Bem-vindo de volta <span id="username">Colecionador</span>, suas coleções te esperam...</h2>

        <section class="stats">
            <div class="stat">
                <span class="stat-number" id="total-figures">0</span>
                <span>Figuras salvas</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="total-collections">0</span>
                <span>Coleções criadas</span>
            </div>

            <div class="recent">
                <h4>Últimas adicionadas</h4>
                <div class="recent-grid" id="recent-grid">
                    </div>
            </div>
        </section>

        <hr>

        <section class="collections-section">
            <h3>Suas Coleções</h3>
            <div class="collections" id="collections-container">
                <p style="color: #666; padding: 20px;">Você ainda não possui coleções.</p>
                </div>
        </section>

        <section class="novidades-section">
            <div class="new-text">
                <h3>Novidades</h3>
                <a th:href="@{/explorar}">Ver mais...</a>
            </div>

            <div class="news-grid" id="news-grid">
                </div>
        </section>

        <section class="populares-section">
            <div class="new-text">
                <h3>Populares no momento</h3>
                <a th:href="@{/explorar}">Ver mais...</a>
            </div>

            <div class="popular-grid" id="popular-grid">
                </div>
        </section>
    </main>

    <script>
        // --- CONFIGURAÇÃO ---
        const API_BASE = '/api'; // Aponta para o próprio Spring Boot (8080)

        // --- AUTENTICAÇÃO ---
        function checkAuth() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) {
                window.location.href = '/login'; // Redireciona se não estiver logado
                return null;
            }
            return token;
        }

        // --- CARREGAMENTO DE DADOS ---

        // 1. Dados do Usuário
        // Em vez de chamar a API (que ainda não tem endpoint de profile),
        // pegamos do localStorage que salvamos na tela de Login.
        function loadUserData() {
            const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                // Tenta pegar username ou nome, ou define um padrão
                const nomeExibicao = user.username || user.nome || 'Colecionador';
                document.getElementById('username').textContent = nomeExibicao;
                
                // Atualiza também no Header se houver o campo lá
                const headerName = document.getElementById('header-user-name');
                if(headerName) headerName.textContent = nomeExibicao;
            }
        }

        // 2. Estatísticas (Mock temporário até você criar o Controller de Stats)
        async function loadStats() {
            // Deixamos como 0 por enquanto para não dar erro 404
            document.getElementById('total-figures').textContent = "0";
            document.getElementById('total-collections').textContent = "0";
        }

        // 3. Novidades e Populares
        // Como você só tem o CatalogoController por enquanto, vamos buscar TUDO
        // e filtrar no front-end para exibir algo na tela.
        async function loadCatalogoData() {
            try {
                // Chama seu endpoint existente: /api/catalogo
                const response = await fetch(`${API_BASE}/catalogo`);
                if (!response.ok) throw new Error('Erro ao buscar catálogo');
                
                const figures = await response.json();

                // -- Novidades (Pega as 4 últimas do array) --
                const novidades = figures.slice(-4).reverse();
                renderGrid('news-grid', novidades);
                renderGrid('recent-grid', novidades.slice(0, 3)); // Reusa para "Últimas adicionadas"

                // -- Populares (Pega as 4 primeiras do array como exemplo) --
                const populares = figures.slice(0, 4);
                renderGrid('popular-grid', populares);

            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // Função auxiliar para desenhar os cards
        function renderGrid(elementId, lista) {
            const grid = document.getElementById(elementId);
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (lista.length === 0) {
                grid.innerHTML = '<p>Nenhuma figura encontrada.</p>';
                return;
            }

            lista.forEach(fig => {
                const card = document.createElement('div');
                // Define a classe dependendo de onde está sendo renderizado
                card.className = elementId === 'recent-grid' ? 'recent-card' : 'news-card'; 
                
                // Monta o HTML do card
                card.innerHTML = `
                    <img src="${fig.urlFoto || '/img/placeholder.png'}" alt="${fig.nome}">
                    ${elementId !== 'recent-grid' ? `<div class="card-info"><h4>${fig.nome}</h4></div>` : ''}
                `;
                
                // Ao clicar, vai para a rota do WebController: /detalhes?id=X
                card.onclick = () => window.location.href = `/detalhes?id=${fig.id}`;
                
                grid.appendChild(card);
            });
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = checkAuth();
            if (token) {
                loadUserData();
                loadStats();
                loadCatalogoData(); // Carrega as figuras
                // loadCollections(); // Comentado até você criar o backend de coleções
            }
        });
    </script>
</body>
</html>