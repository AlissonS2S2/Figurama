<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criando uma coleção</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/components/cards.css">
    <link rel="stylesheet" href="css/components/buttons.css">
    <link rel="stylesheet" href="css/components/forms.css">
    <link rel="stylesheet" href="css/pages/criando_colecao.css">
</head>
<body>
    <header class="header-logged">
        <a href="dashboard.html">
            <img class="logo" src="images/Logo.png" alt="Logo Figurama">
        </a>
        
        <nav class="nav-logged">
            <span>
                <img class="profile-icon" src="icons/Profile-icon.png" alt="Descrição da imagem">N_Usuário</span>
            <a href="#">Coleção</a>
            <input type="text" placeholder="Pesquisar">
            <button class="btn-add">Adicionar +</button>
        </nav>
    </header>

    <main class="creating-container">
        <div class="">
            <h1 class="create-title">Criando uma coleção</h1>

            <form id="collection-form">
                <div class="form">
                    <label>Título</label>
                    <input type="text" name="title" required>
                </div>

                <div class="form">
                    <label>Descrição</label>
                    <textarea name="description" cols="60" rows="15" required></textarea>
                </div>

                <div class="figures-add">
                    <label class="add-label">Adicionar Action Figures</label>
                    <input type="text" class="search-figures" placeholder="Pesquise e selecione para adicionar">

                    <div class=figure-grid>
                        <div class="figure-card-pchd"></div>
                        <div class="figure-card-pchd"></div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="cancelForm()">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>   
        </div>
    </main>

    <script>
        // ============================================
// CRIAR COLEÇÃO - Integração com Backend
// ============================================

// Variável para armazenar figures selecionadas
let selectedFigures = [];

// ============================================
// 1. BUSCAR ACTION FIGURES (PESQUISA)
// ============================================
document.querySelector('.search-figures').addEventListener('input', async function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    if (searchTerm.length < 2) return; // Só busca com 2+ caracteres
    
    // *** INTEGRAÇÃO COM BACKEND - BUSCAR FIGURES ***
    // Endpoint: GET /api/figures/search?query=batman
    // Retorna: [ { id: 1, nome: "Batman", imagem: "url..." }, ... ]
    
    try {
        const response = await fetch(`/api/figures/search?query=${searchTerm}`);
        const figures = await response.json();
        
        // Renderizar resultados da busca
        renderSearchResults(figures);
    } catch (error) {
        console.error('Erro ao buscar figures:', error);
    }
});

// ============================================
// 2. RENDERIZAR RESULTADOS DA BUSCA
// ============================================
function renderSearchResults(figures) {
    const grid = document.querySelector('.figure-grid');
    
    // Limpar placeholders
    grid.innerHTML = '';
    
    // Renderizar cada figure encontrada
    figures.forEach(figure => {
        const card = document.createElement('div');
        card.className = 'figure-card-pchd';
        card.dataset.figureId = figure.id;
        
        // *** DADOS VÊM DO BANCO DE DADOS ***
        // figure.id - ID da action figure no banco
        // figure.nome - Nome da action figure
        // figure.imagem - URL da imagem
        
        card.innerHTML = `
            <img src="${figure.imagem}" alt="${figure.nome}">
            <span>${figure.nome}</span>
        `;
        
        // Adicionar evento de clique para selecionar
        card.addEventListener('click', () => toggleFigureSelection(card, figure));
        
        grid.appendChild(card);
    });
}

// ============================================
// 3. SELECIONAR/DESSELECIONAR FIGURES
// ============================================
function toggleFigureSelection(card, figure) {
    card.classList.toggle('selected');
    
    const index = selectedFigures.findIndex(f => f.id === figure.id);
    
    if (index > -1) {
        // Remover da seleção
        selectedFigures.splice(index, 1);
    } else {
        // Adicionar à seleção
        selectedFigures.push(figure);
    }
}

// ============================================
// 4. VALIDAR FORMULÁRIO
// ============================================
function validateForm() {
    const title = document.querySelector('input[name="title"]').value.trim();
    const description = document.querySelector('textarea[name="description"]').value.trim();
    
    if (!title) {
        alert('Por favor, insira um título para a coleção');
        return false;
    }
    
    if (!description) {
        alert('Por favor, insira uma descrição para a coleção');
        return false;
    }
    
    if (selectedFigures.length === 0) {
        alert('Por favor, adicione pelo menos uma action figure');
        return false;
    }
    
    return true;
}

// ============================================
// 5. ENVIAR DADOS PARA O BACKEND (CRIAR COLEÇÃO)
// ============================================
document.getElementById('collection-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    const title = document.querySelector('input[name="title"]').value.trim();
    const description = document.querySelector('textarea[name="description"]').value.trim();
    
    // Preparar dados para envio
    const collectionData = {
        nome: title,
        descricao: description,
        figures: selectedFigures.map(f => f.id) // Apenas os IDs das figures
    };
    
    // Desabilitar botão durante envio
    const btnSave = document.querySelector('.btn-save');
    btnSave.textContent = 'Salvando...';
    btnSave.disabled = true;
    
    // *** INTEGRAÇÃO COM BACKEND - CRIAR COLEÇÃO ***
    // Endpoint: POST /api/colecoes
    // Body: { nome: "string", descricao: "string", figures: [1, 2, 3] }
    // Retorna: { id: 123, nome: "...", mensagem: "Coleção criada" }
    
    try {
        const response = await fetch('/api/colecoes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // *** TOKEN DE AUTENTICAÇÃO ***
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify(collectionData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // *** SUCESSO - COLEÇÃO CRIADA NO BANCO ***
            alert('Coleção criada com sucesso!');
            
            // Redirecionar para a página da coleção criada
            window.location.href = `colecao.html?id=${data.id}`;
        } else {
            // *** ERRO DO SERVIDOR ***
            alert(data.mensagem || 'Erro ao criar coleção');
        }
        
    } catch (error) {
        console.error('Erro ao criar coleção:', error);
        alert('Erro ao conectar com o servidor');
    } finally {
        // Restaurar botão
        btnSave.textContent = 'Salvar';
        btnSave.disabled = false;
    }
});

// ============================================
// 6. CANCELAR E VOLTAR
// ============================================
function cancelForm() {
    if (confirm('Deseja cancelar? As alterações não serão salvas.')) {
        window.location.href = 'dashboard.html';
    }
}

// ============================================
// 7. CARREGAR FIGURES INICIAIS (OPCIONAL)
// ============================================
async function loadInitialFigures() {
    // *** INTEGRAÇÃO COM BACKEND - CARREGAR FIGURES POPULARES/RECENTES ***
    // Endpoint: GET /api/figures/recent?limit=10
    // Retorna: [ { id: 1, nome: "...", imagem: "..." }, ... ]
    
    try {
        const response = await fetch('/api/figures/recent?limit=10');
        const figures = await response.json();
        
        renderSearchResults(figures);
    } catch (error) {
        console.error('Erro ao carregar figures:', error);
    }
}

// ============================================
// INICIALIZAR
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    // Carregar algumas figures iniciais (opcional)
    // loadInitialFigures();
});


// ============================================
// ESTRUTURA ESPERADA DO BACKEND
// ============================================

/*
ENDPOINTS NECESSÁRIOS:

1. Buscar Action Figures
   GET /api/figures/search?query=batman
   Resposta: [
     { id: 1, nome: "Batman", imagem: "url...", franquia: "DC" },
     { id: 2, nome: "Batgirl", imagem: "url...", franquia: "DC" }
   ]

2. Criar Coleção
   POST /api/colecoes
   Headers: { Authorization: "Bearer TOKEN" }
   Body: {
     nome: "Minha Coleção",
     descricao: "Descrição aqui",
     figures: [1, 2, 3]
   }
   Resposta: {
     id: 123,
     nome: "Minha Coleção",
     mensagem: "Coleção criada com sucesso"
   }

3. Figures Recentes/Populares (opcional)
   GET /api/figures/recent?limit=10
   Resposta: [ { id: 1, nome: "...", imagem: "..." }, ... ]
*/
    </script>
    
</body>
</html>