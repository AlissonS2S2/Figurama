<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Figurama</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/pages/index.css}">
    <link rel="stylesheet" th:href="@{/css/components/buttons.css}">
    <link rel="stylesheet" th:href="@{/css/components/cards.css}">
    <link rel="stylesheet" th:href="@{/css/components/forms.css}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/header :: comum}"></div>

    <section class="main">
    <div class="main-image">
        <img src="/img/Deadpool-Figurama.jpg" alt="Deadpool Figurama">
    </div>
    <div class="main-text">
    <h1>
        Adicione Figuras que você tem.<br>
        Favorite as que deseja.<br>
        Compartilhe com seus amigos.
    </h1>
    <a th:href="@{/cadastro}">
        <button class="cta-btn" id="startBtn">Comece agora - é de graça</button>
    </a>
</div>
</section>

<section class="novidades">
    <h2>Novidades</h2>
    <!-- BANCO DE DADOS: Buscar 6 figuras específicas para "No3vidades" -->
    <div class="cards-grid" id="novidadesGrid">
        <!-- Cards inseridos via JavaScript -->
    </div>
</section>

<section class="popular">
    <h2>Populares no momento</h2>
    <!-- BANCO DE DADOS: Buscar 6 figuras específicas para "Populares" -->
    <div class="cards-grid" id="popularGrid">
        <!-- Cards inseridos via JavaScript -->
    </div>
</section>

<div th:replace="~{fragments/footer :: rodape}"></div>

<script>
    // 1. A URL Base correta
    // Como o HTML é servido pelo próprio Spring Boot, não precisamos colocar "http://localhost:8080"
    // Usamos apenas o caminho relativo. Isso evita problemas de CORS.
    const API_BASE_URL = '/api/catalogo'; 

    // Referências aos elementos do DOM
    const figuresGrid = document.getElementById('figuresGrid');
    const searchInput = document.querySelector('.search-box input'); // Ajuste o seletor se necessário

    // 2. Função para carregar TODAS as figuras
    async function carregarFiguras() {
        try {
            // No seu Controller, o @GetMapping sem caminho extra lista tudo
            // Então chamamos direto: /api/catalogo
            const response = await fetch(API_BASE_URL);
            
            if (!response.ok) throw new Error('Erro ao buscar dados');
            
            const figures = await response.json();
            renderizarFiguras(figures);
        } catch (error) {
            console.error('Erro:', error);
            figuresGrid.innerHTML = '<p>Erro ao carregar o catálogo.</p>';
        }
    }

    // 3. Função de Pesquisa
    async function pesquisarFiguras(termo) {
        try {
            // No seu Controller: @GetMapping("/pesquisar") com @RequestParam("nome")
            // A URL final deve ficar: /api/catalogo/pesquisar?nome=Naruto
            const url = `${API_BASE_URL}/pesquisar?nome=${encodeURIComponent(termo)}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro na pesquisa');
            
            const figures = await response.json();
            renderizarFiguras(figures);
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    // 4. Renderização (HTML dos cards)
    function renderizarFiguras(lista) {
        figuresGrid.innerHTML = ''; // Limpa a lista atual

        if (lista.length === 0) {
            figuresGrid.innerHTML = '<p>Nenhuma figura encontrada.</p>';
            return;
        }

        lista.forEach(figura => {
            // Ajuste os nomes das propriedades conforme seu Modelo Java (CatalogoActionFigure)
            // Ex: figura.nome, figura.urlFoto, figura.precoSugerido
            const card = document.createElement('div');
            card.className = 'figure-card'; // Use sua classe CSS de card
            card.innerHTML = `
                <img src="${figura.urlFoto || '/img/default-placeholder.png'}" alt="${figura.nome}">
                <h3>${figura.nome}</h3>
                <p class="categoria">${figura.categoria}</p>
                <p class="preco">R$ ${figura.precoSugerido ? figura.precoSugerido.toFixed(2) : '0.00'}</p>
            `;
            figuresGrid.appendChild(card);
        });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', carregarFiguras);

    // Adiciona delay na pesquisa para não chamar a API a cada letra digitada (Debounce simples)
    let timeoutId;
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                const termo = e.target.value;
                if (termo.trim()) {
                    pesquisarFiguras(termo);
                } else {
                    carregarFiguras();
                }
            }, 500); // Espera 500ms após parar de digitar
        });
    }
</script>
</body>
</html>
